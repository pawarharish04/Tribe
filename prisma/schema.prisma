generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String         @id @default(uuid())
  username                 String         @unique
  email                    String         @unique
  passwordHash             String
  latitude                 Float?
  longitude                Float?
  interestChangesRemaining Int            @default(3)
  resetAt                  DateTime       @default(now())
  createdAt                DateTime       @default(now())
  interests                UserInterest[]
  prompts                  UserPrompt[]
  interactionsSent         Interaction[]  @relation("InteractionsSent")
  interactionsReceived     Interaction[]  @relation("InteractionsReceived")
  chatsUser1               MatchUnlock[]  @relation("MatchUser1")
  chatsUser2               MatchUnlock[]  @relation("MatchUser2")
  messages                 Message[]
}

model Interest {
  id        String         @id @default(uuid())
  name      String         @unique
  category  String
  createdAt DateTime       @default(now())
  users     UserInterest[]
}

model UserInterest {
  userId     String
  interestId String
  strength   StrengthLevel @default(CURIOUS)
  updatedAt  DateTime      @updatedAt
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest      @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
}

enum StrengthLevel {
  CURIOUS
  SERIOUS
  CORE
}

model Prompt {
  id       String       @id @default(uuid())
  question String       @unique
  category String
  users    UserPrompt[]
}

model UserPrompt {
  userId   String
  promptId String
  answer   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@id([userId, promptId])
}

model Interaction {
  id         String          @id @default(uuid())
  fromUserId String
  toUserId   String
  type       InteractionType
  createdAt  DateTime        @default(now())
  fromUser   User            @relation("InteractionsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User            @relation("InteractionsReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId, type])
}

enum InteractionType {
  LIKE
  SIGNAL
}

model MatchUnlock {
  id         String    @id @default(uuid())
  user1Id    String
  user2Id    String
  unlockedAt DateTime  @default(now())
  user1      User      @relation("MatchUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2      User      @relation("MatchUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages   Message[]

  @@unique([user1Id, user2Id])
}

model Message {
  id        String      @id @default(uuid())
  matchId   String
  senderId  String
  content   String
  createdAt DateTime    @default(now())
  match     MatchUnlock @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender    User        @relation(fields: [senderId], references: [id], onDelete: Cascade)
}
